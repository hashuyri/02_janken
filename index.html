<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ボールゲーム</title>
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+JP" rel="stylesheet" />
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <main>

    <section>
      <div class="rule_box">
        <h1>ボールゲーム</h1>
        <p>あなたのボールは生き残れるか！！</p>

        <h2>ルール説明</h2>
        <ul>
          <li>BOX内を動き回る7個のボールの内、一つを選択する</li>
          <li>ボールはそれぞれ大きさと衝突上限回数が異なる</li>
          <li>ボールは衝突上限回数に達した場合消滅する</li>
          <li>最後の1つになったらゲーム終了</li>
          <li>同時に衝突上限回数に達した場合スピードが早い方が勝ち</li>
        </ul>
      </div>
    </section>

    <section>
      <canvas width="1000px" height="600px" id="canvas"></canvas>
    </section>

    <section>
      <div id="btn_box">
        <button id="result_btn">結果</button>
        <button id="submit">最初から</button>
      </div>
    </section>

  </main>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script>

    // 画面をリロード
    $(document).ready(function () {
      $("#submit").click(function () {
        $(location).prop("href", location.href);
      })
    });

    let balls = [{ x: 200, y: 200, radius: 130, speedx: 1, speedy: 1 }, // white
    { x: 700, y: 150, radius: 110, speedx: 2, speedy: 2 }]; // yellow
    // { x: 100, y: 100, radius: 90, speedx: 4, speedy: 4 }, // green
    // { x: 100, y: 100, radius: 70, speedx: 5, speedy: 5 }, // gray
    // { x: 100, y: 100, radius: 50, speedx: 8, speedy: 8 }, // red
    // { x: 100, y: 100, radius: 30, speedx: 10, speedy: 10 },  // purple
    // { x: 100, y: 100, radius: 10, speedx: 20, speedy: 20 }]; // blue
    let canvas = document.getElementById("canvas");
    let ctx = canvas.getContext("2d");
    let main_distance = 0;
    let sab_distance = 0;

    function drawArc_white() {
      ctx.beginPath();
      ctx.arc(balls[0].x, balls[0].y, balls[0].radius, 0, Math.PI * 2, false);
      ctx.strokeStyle = "#ffffff";
      ctx.stroke();
      ctx.fillStyle = "#ffffff";
      ctx.fill();
      ctx.closePath();
    }
    function drawArc_yellow() {
      ctx.beginPath();
      ctx.arc(balls[1].x, balls[1].y, balls[1].radius, 0, Math.PI * 2, false);
      ctx.strokeStyle = "#ffff00";
      ctx.stroke();
      ctx.fillStyle = "#ffff00";
      ctx.fill();
      ctx.closePath();
    }
    function drawArc_green() {
      ctx.beginPath();
      ctx.arc(balls[2].x, balls[2].y, balls[2].radius, 0, Math.PI * 2, false);
      ctx.strokeStyle = "#006400";
      ctx.stroke();
      ctx.fillStyle = "#006400";
      ctx.fill();
      ctx.closePath();
    }
    function drawArc_gray() {
      ctx.beginPath();
      ctx.arc(balls[3].x, balls[3].y, balls[3].radius, 0, Math.PI * 2, false);
      ctx.strokeStyle = "#808080";
      ctx.stroke();
      ctx.fillStyle = "#808080";
      ctx.fill();
      ctx.closePath();
    }
    function drawArc_red() {
      ctx.beginPath();
      ctx.arc(balls[4].x, balls[4].y, balls[4].radius, 0, Math.PI * 2, false);
      ctx.strokeStyle = "#eb2142";
      ctx.stroke();
      ctx.fillStyle = "#eb2142";
      ctx.fill();
      ctx.closePath();
    }
    function drawArc_purple() {
      ctx.beginPath();
      ctx.arc(balls[5].x, balls[5].y, balls[5].radius, 0, Math.PI * 2, false);
      ctx.strokeStyle = "#800080";
      ctx.stroke();
      ctx.fillStyle = "#800080";
      ctx.fill();
      ctx.closePath();
    }
    function drawArc_blue() {
      ctx.beginPath();
      ctx.arc(balls[6].x, balls[6].y, balls[6].radius, 0, Math.PI * 2, false);
      ctx.strokeStyle = "#0000cd";
      ctx.stroke();
      ctx.fillStyle = "#0000cd";
      ctx.fill();
      ctx.closePath();
    }

    // ボールを動かす
    function move(i) {
      balls[i].x += balls[i].speedx;
      balls[i].y += balls[i].speedy;
    }

    // キャンバスの壁の当たり判定
    function wall_bound(i) {
      if (balls[i].x + balls[i].radius >= canvas.width || balls[i].x - balls[i].radius <= 0) {
        balls[i].speedx *= -1;
      }

      if (balls[i].y + balls[i].radius >= canvas.height || balls[i].y - balls[i].radius <= 0) {
        balls[i].speedy *= -1;
      }
    }

    // ボール同士の当たり判定
    let diagonal_line = [];
    for (let i = 0; i < balls.length; i++) {
      // 1描写当たりに進む距離
      diagonal_line.push(Math.sqrt(balls[i].speedx ** 2 + balls[i].speedy ** 2));
    }
    function ball_bound() {
      for (let i = 0; i < balls.length; i++) {
        for (let j = i + 1; j < balls.length; j++) {
          // 各円のそれぞれの中点の距離
          main_distance = Math.floor(Math.sqrt((balls[i].x - balls[j].x) ** 2 + (balls[i].y - balls[j].y) ** 2));
          // 円の内側に接する正方形に対する中点からの最短距離
          sab_distance = balls[i].radius / Math.sqrt(2);
          
          // 当たり判定がTrueの場合
          if (main_distance === balls[i].radius + balls[j].radius + 1) {
            // X方向の運動を主として考える
            if (balls[j].x - balls[j].radius > balls[i].x + sab_distance ||
            balls[j].x + balls[j].radius < balls[i].x - sab_distance) {
              // 接点のX座標がballs[i].xからどれだけ離れているか及びボールの大きさの違いをspeedxに反映
              // if (balls[j].x > balls[i].x) { // balls[i]の右側で接している
                // balls[i]のX方向の運動を修正
                // balls[i].speedx += balls[j].speedx * Math.abs(balls[i].x - (balls[j].x - balls[j].radius)) / balls[i].radius * balls[j].radius / balls[i].radius * 0.7;
                // // balls[j]のX方向の運動を修正
                // balls[j].speedx += balls[i].speedx * Math.abs(balls[j].x - (balls[i].x + balls[i].radius)) / balls[j].radius * balls[i].radius / balls[j].radius * 0.7;
                balls[j].speedx *= -1;
                
              // } else { // balls[i]の左側で接している
                  //           // balls[i]のX方向の運動を修正
                  //           balls[i].speedx += balls[j].speedx * Math.abs(balls[i].x - (balls[j].x + balls[j].radius)) / balls[i].radius * balls[j].radius / balls[i].radius;
                  //           // balls[j]のX方向の運動を修正
                  //           balls[j].speedx += balls[i].speedx * Math.abs(balls[j].x - (balls[i].x - balls[i].radius)) / balls[j].radius * balls[i].radius / balls[j].radius;
              // }
                
              // balls[i]のY方向の運動を修正
              balls[i].speedy = Math.sqrt(diagonal_line[i] ** 2 - balls[i].speedx ** 2) * (balls[i].speedy / Math.abs(balls[i].speedy)); // Y方向の運動は符号を保ったまま
              // balls[j]のY方向の運動を修正
              balls[j].speedy = Math.sqrt(diagonal_line[j] ** 2 - balls[j].speedx ** 2) * (balls[j].speedy / Math.abs(balls[j].speedy)); // Y方向の運動は符号を保ったまま

      //       } else { // Y方向の運動を主として考える
      //         if (balls[j].y > balls[i].y) { // balls[i]の下側で接している
      //           // balls[i]のY方向の運動を修正
      //           balls[i].speedy += balls[j].speedy * Math.abs(balls[i].y - (balls[j].y - balls[j].radius)) / balls[i].radius * balls[j].radius / balls[i].radius;
      //           // balls[j]のY方向の運動を修正
      //           balls[j].speedy += balls[i].speedy * Math.abs(balls[j].y - (balls[i].y + balls[i].radius)) / balls[j].radius * balls[i].radius / balls[j].radius;

      //         } else { // balls[i]の上側で接している
      //           // balls[i]のY方向の運動を修正
      //           balls[i].speedy += balls[j].speedy * Math.abs(balls[i].y - (balls[j].y + balls[j].radius)) / balls[i].radius * balls[j].radius / balls[i].radius;
      //           // balls[j]のY方向の運動を修正
      //           balls[j].speedy += balls[i].speedy * Math.abs(balls[j].y - (balls[i].y - balls[i].radius)) / balls[j].radius * balls[i].radius / balls[j].radius;
      //         }

      //         // balls[i]のX方向の運動を修正
      //         balls[i].speedx = Math.sqrt(diagonal_line[i] ** 2 - balls[i].speedy ** 2) * (balls[i].speedx / Math.abs(balls[i].speedx)); // X方向の運動は符号を保ったまま
      //         // balls[j]のX方向の運動を修正
      //         balls[j].speedx = Math.sqrt(diagonal_line[j] ** 2 - balls[j].speedy ** 2) * (balls[j].speedx / Math.abs(balls[j].speedx)); // X方向の運動は符号を保ったまま
            }
          }
        }
      }
    }

    // キャンバス内を動き回る描写
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height); // キャンバス内の描画をすべてクリアする（X始点, Y始点, 横幅, 高さ）
      drawArc_white();
      drawArc_yellow();
      // drawArc_green();
      // drawArc_gray();
      // drawArc_red();
      // drawArc_purple();
      // drawArc_blue();
      for (let i = 0; i < balls.length; i++) {
        move(i);
        wall_bound(i);
      }
      ball_bound();
    }

    // 25ミリ秒間隔で描き続ける
    setInterval(draw, 25);

  </script>
</body>

</html>