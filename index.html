<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ボールゲーム</title>
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+JP" rel="stylesheet" />
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <main>

    <section>
      <div class="rule_box">
        <h1>ボールゲーム</h1>
        <p>あなたのボールは生き残れるか！！</p>

        <h2>ルール説明</h2>
        <ul>
          <li>BOX内を動き回る7個のボールの内、一つを選択する</li>
          <li>ボールは衝突上限回数に達した場合消滅する</li>
          <li>ボールの衝突上限回数は50回</li>
          <li>最後の1つになったらゲーム終了</li>
        </ul>
        <p>※壁への当たりも衝突回数に含める</p>
      </div>
    </section>

    <section id="balls_select">
      <div class="balls_box">
        <div id="white_ball" class="balls"></div>
        <p id="white_count"></p>
      </div>
      <div class="balls_box">
        <div id="yellow_ball" class="balls"></div>
        <p id="yellow_count"></p>
      </div>
      <div class="balls_box">
        <div id="red_ball" class="balls"></div>
        <p id="red_count"></p>
      </div>
      <div class="balls_box">
        <div id="gray_ball" class="balls"></div>
        <p id="gray_count"></p>
      </div>
      <div class="balls_box">
        <div id="green_ball" class="balls"></div>
        <p id="green_count"></p>
      </div>
      <div class="balls_box">
        <div id="purple_ball" class="balls"></div>
        <p id="purple_count"></p>
      </div>
      <div class="balls_box">
        <div id="blue_ball" class="balls"></div>
        <p id="blue_count"></p>
      </div>
    </section>

    <section>
      <canvas width="1000px" height="600px" id="canvas"></canvas>
    </section>

    <section>
      <div id="btn_box">
        <button id="result_btn">結果</button>
        <button id="submit">最初から</button>
      </div>
    </section>

  </main>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script>

    // 画面をリロード
    $(document).ready(function () {
      $("#submit").click(function () {
        $(location).prop("href", location.href);
      })
    });

    const x = 2;
    const y = 2;
    let canvas = document.getElementById("canvas");
    let ctx = canvas.getContext("2d");
    let main_distance = 0;
    let sab_distance = 0;
    let correction = 0;
    
    let firstXarray = [70, 210, 350, 490, 630, 770, 910];
    firstXarray = arrangement(firstXarray);
    
    let balls = [{ x: 0, y: 0, radius: 50, speedx: x, speedy: y },
    { x: 0, y: 0, radius: 50, speedx: x, speedy: y },
    { x: 0, y: 0, radius: 50, speedx: x, speedy: y },
    { x: 0, y: 0, radius: 50, speedx: x, speedy: y },
    { x: 0, y: 0, radius: 50, speedx: x, speedy: y },
    { x: 0, y: 0, radius: 50, speedx: x, speedy: y },
    { x: 0, y: 0, radius: 50, speedx: x, speedy: y }];
    let color = ["#ffffff", "#ffff00", "#006400", "#eb2142", "#808080", "#800080", "#0000cd"];
    color = arrangement(color);
    
    // ボールの初期配置の決定
    for (let i = 0; i < balls.length; i++) {
      balls[i].x = firstXarray[i];
      balls[i].y = Math.floor(Math.random() * (canvas.height - (balls[i].radius * 2))) + balls[i].radius;
      // ランダムに選んだYの値が奇数なら-X軸方向に動かす
      if (balls[i].y % 2 == 1) {
        balls[i].speedx *= -1;
      }

      // ランダムに選んだYの10の位がが奇数なら-Y軸方向に動かす
      if (Math.floor(balls[i].y / 10) % 2 == 1) {
        balls[i].speedy *= -1;
      }
    }

    // 配列をシャッフルする
    function arrangement(array) {
      for (let i = array.length - 1; i > 0; i--) {
        // 0〜(i+1)の範囲で値を取得
        let r = Math.floor(Math.random() * (i + 1));

        // 要素の並び替えを実行
        let tmp = array[i];
        array[i] = array[r];
        array[r] = tmp;
      }
      return array;
    }

    function drawArc(i) {
      ctx.beginPath();
      // 補正
      correctionback();
      // ボール同士の当たり判定
      ball_bound();
      wall_bound(i);
      ctx.arc(balls[i].x, balls[i].y, balls[i].radius, 0, Math.PI * 2, false);
      ctx.strokeStyle = color[i];
      ctx.stroke();
      ctx.fillStyle = color[i];
      ctx.fill();
      ctx.closePath();
      move(i);
    }

    // ボールを動かす
    function move(i) {
      balls[i].x += balls[i].speedx;
      // 厳密に壁の当たり判定を実施
      if (balls[i].x < balls[i].radius) {
        balls[i].x = balls[i].radius
      } else if (balls[i].x > canvas.width - balls[i].radius) {
        balls[i].x = canvas.width - balls[i].radius
      }
      
      // 厳密に壁の当たり判定を実施
      balls[i].y += balls[i].speedy;
      if (balls[i].y < balls[i].radius) {
        balls[i].y = balls[i].radius
      } else if (balls[i].y > canvas.height - balls[i].radius) {
        balls[i].y = canvas.height - balls[i].radius
      }
    }

    // キャンバスの壁の当たり判定
    function wall_bound(i) {
      if (balls[i].x + balls[i].radius >= canvas.width || balls[i].x - balls[i].radius <= 0) {
        balls[i].speedx *= -1;
      }

      if (balls[i].y + balls[i].radius >= canvas.height || balls[i].y - balls[i].radius <= 0) {
        balls[i].speedy *= -1;
      }
    }

    // ボール同士の当たり判定
    function ball_bound() {
      for (let i = 0; i < balls.length; i++) {
        for (let j = i + 1; j < balls.length; j++) {
          // 各円のそれぞれの中点の距離
          main_distance = Math.sqrt((balls[i].x - balls[j].x) ** 2 + (balls[i].y - balls[j].y) ** 2);
          // 円の内側に接する正方形に対する中点からの最短距離
          sab_distance = balls[i].radius / Math.sqrt(2);
          
          // 当たり判定がTrueの場合
          if (main_distance <= balls[i].radius + balls[j].radius) {
            // X方向の運動を主として考える
            if (balls[j].x + balls[j].radius < balls[i].x - sab_distance) { // balls[i]の左側に当たった場合
              if (balls[i].speedx != balls[j].speedx) {
                balls[i].speedx *= -1;
              }
              balls[j].speedx *= -1;
            } else if (balls[j].x - balls[j].radius > balls[i].x + sab_distance) { // balls[i]の右側に当たった場合
              if (balls[i].speedx != balls[j].speedx) {
                balls[j].speedx *= -1;
              }
              balls[i].speedx *= -1;
            } else if (balls[j].y + balls[j].radius <= balls[i].y - sab_distance) { // balls[i]の上側に当たった場合
              if (balls[i].speedy != balls[j].speedy) {
                balls[j].speedy *= -1;
              }
              balls[i].speedy *= -1;
            } else { // balls[i]の下側に当たった場合
              if (balls[i].speedy != balls[j].speedy) {
                balls[i].speedy *= -1;
              }
              balls[j].speedy *= -1;
            }
          }
        }
      }
    }
    
    // 描画時にボールがめり込んだ状態であったら描画する前に補正
    function correctionback() {
      for (let i = 0; i < balls.length; i++) {
        for (let j = i + 1; j < balls.length; j++) {
          main_distance = Math.sqrt((balls[i].x - balls[j].x) ** 2 + (balls[i].y - balls[j].y) ** 2);
          if (main_distance < balls[i].radius + balls[j].radius) {
            correction = balls[i].radius + balls[j].radius - main_distance;
            balls[i].x -= Math.floor(correction / Math.sqrt(2) * 10000000000) / 10000000000 * balls[i].speedx / Math.abs(balls[i].speedx);
            balls[i].y -= Math.floor(correction / Math.sqrt(2) * 10000000000) / 10000000000 * balls[i].speedy / Math.abs(balls[i].speedy);
          }
        }
      }
    }

    // 次回の描画時にまだボールがめり込んだ状態であったら補正
    function correctionforward() {
      for (let i = 0; i < balls.length; i++) {
        for (let j = i + 1; j < balls.length; j++) {
          main_distance = Math.sqrt((balls[i].x - balls[j].x) ** 2 + (balls[i].y - balls[j].y) ** 2);
          if (main_distance < balls[i].radius + balls[j].radius) {
            correction = balls[i].radius + balls[j].radius - main_distance;
            balls[i].x += Math.floor(correction / Math.sqrt(2) * 100000) / 100000 * balls[i].speedx / Math.abs(balls[i].speedx);
            balls[i].y += Math.floor(correction / Math.sqrt(2) * 100000) / 100000 * balls[i].speedy / Math.abs(balls[i].speedy);
            balls[j].x += Math.floor(correction / Math.sqrt(2) * 100000) / 100000 * balls[j].speedx / Math.abs(balls[j].speedx);
            balls[j].y += Math.floor(correction / Math.sqrt(2) * 100000) / 100000 * balls[j].speedy / Math.abs(balls[j].speedy);
          }
        }
      }
    }

    // キャンバス内を動き回る描写
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height); // キャンバス内の描画をすべてクリアする（X始点, Y始点, 横幅, 高さ）
      for (let i = 0; i < balls.length; i++) {
        drawArc(i);
      }
      correctionforward();
    }

    // 25ミリ秒間隔で描き続ける
    setInterval(draw, 10);

  </script>
</body>

</html>