<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ボールゲーム</title>
  <link href="https://fonts.googleapis.com/css?family=Noto+Sans+JP" rel="stylesheet" />
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <main>

    <section>
      <div class="rule_box">
        <h1>ボールゲーム</h1>
        <p>あなたのボールは生き残れるか！！</p>

        <h2>ルール説明</h2>
        <ul>
          <li>BOX内を動き回る7個のボールの内、一つを選択する</li>
          <li>ボールはそれぞれ大きさと衝突上限回数が異なる</li>
          <li>ボールは衝突上限回数に達した場合消滅する</li>
          <li>最後の1つになったらゲーム終了</li>
          <li>同時に衝突上限回数に達した場合スピードが早い方が勝ち</li>
        </ul>
      </div>
    </section>

    <section>
      <canvas width="1000px" height="600px" id="canvas"></canvas>
    </section>

    <section>
      <div id="btn_box">
        <button id="result_btn">結果</button>
        <button id="submit">最初から</button>
      </div>
    </section>

  </main>

  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
  <script>

    // 画面をリロード
    $(document).ready(function () {
      $("#submit").click(function () {
        $(location).prop("href", location.href);
      })
    });

    let balls = [{ x: 100, y: 100, radius: 50, speedx: 1, speedy: 1 }, // white
    { x: 200, y: 200, radius: 50, speedx: 1, speedy: 1 }, // yellow
    { x: 500, y: 300, radius: 50, speedx: 1, speedy: 1 }, // green
    { x: 500, y: 500, radius: 50, speedx: 1, speedy: 1 }, // red
    { x: 400, y: 400, radius: 50, speedx: 1, speedy: 1 }, // gray
    { x: 600, y: 200, radius: 50, speedx: 1, speedy: 1 },  // purple
    { x: 700, y: 300, radius: 50, speedx: 1, speedy: 1 }]; // blue

    let canvas = document.getElementById("canvas");
    let ctx = canvas.getContext("2d");
    let main_distance = 0;
    let sab_distance = 0;
    let correction = 0;

    function drawArc_white() {
      ctx.beginPath();
      ctx.arc(balls[0].x, balls[0].y, balls[0].radius, 0, Math.PI * 2, false);
      ctx.strokeStyle = "#ffffff";
      ctx.stroke();
      ctx.fillStyle = "#ffffff";
      ctx.fill();
      ctx.closePath();
    }
    function drawArc_yellow() {
      ctx.beginPath();
      ctx.arc(balls[1].x, balls[1].y, balls[1].radius, 0, Math.PI * 2, false);
      ctx.strokeStyle = "#ffff00";
      ctx.stroke();
      ctx.fillStyle = "#ffff00";
      ctx.fill();
      ctx.closePath();
    }
    function drawArc_green() {
      ctx.beginPath();
      ctx.arc(balls[2].x, balls[2].y, balls[2].radius, 0, Math.PI * 2, false);
      ctx.strokeStyle = "#006400";
      ctx.stroke();
      ctx.fillStyle = "#006400";
      ctx.fill();
      ctx.closePath();
    }
    function drawArc_red() {
      ctx.beginPath();
      ctx.arc(balls[3].x, balls[3].y, balls[3].radius, 0, Math.PI * 2, false);
      ctx.strokeStyle = "#eb2142";
      ctx.stroke();
      ctx.fillStyle = "#eb2142";
      ctx.fill();
      ctx.closePath();
    }
    function drawArc_gray() {
      ctx.beginPath();
      ctx.arc(balls[4].x, balls[4].y, balls[4].radius, 0, Math.PI * 2, false);
      ctx.strokeStyle = "#808080";
      ctx.stroke();
      ctx.fillStyle = "#808080";
      ctx.fill();
      ctx.closePath();
    }
    function drawArc_purple() {
      ctx.beginPath();
      ctx.arc(balls[5].x, balls[5].y, balls[5].radius, 0, Math.PI * 2, false);
      ctx.strokeStyle = "#800080";
      ctx.stroke();
      ctx.fillStyle = "#800080";
      ctx.fill();
      ctx.closePath();
    }
    function drawArc_blue() {
      ctx.beginPath();
      ctx.arc(balls[6].x, balls[6].y, balls[6].radius, 0, Math.PI * 2, false);
      ctx.strokeStyle = "#0000cd";
      ctx.stroke();
      ctx.fillStyle = "#0000cd";
      ctx.fill();
      ctx.closePath();
    }

    // ボールを動かす
    function move(i) {
      balls[i].x += balls[i].speedx;
      balls[i].y += balls[i].speedy;
    }

    // キャンバスの壁の当たり判定
    function wall_bound(i) {
      if (balls[i].x + balls[i].radius >= canvas.width || balls[i].x - balls[i].radius <= 0) {
        balls[i].speedx *= -1;
      }

      if (balls[i].y + balls[i].radius >= canvas.height || balls[i].y - balls[i].radius <= 0) {
        balls[i].speedy *= -1;
      }
    }

    // ボール同士の当たり判定
    function ball_bound() {
      for (let i = 0; i < balls.length; i++) {
        for (let j = i + 1; j < balls.length; j++) {
          // 各円のそれぞれの中点の距離
          main_distance = Math.sqrt((balls[i].x - balls[j].x) ** 2 + (balls[i].y - balls[j].y) ** 2);
          // 円の内側に接する正方形に対する中点からの最短距離
          sab_distance = balls[i].radius / Math.sqrt(2);
          console.log(main_distance, balls[i].speedx, balls[j].speedx)

          // 当たり判定がTrueの場合
          if (main_distance <= balls[i].radius + balls[j].radius) {
            // X方向の運動を主として考える
            if (balls[j].x + balls[j].radius < balls[i].x - sab_distance) { // balls[i]の左側に当たった場合
              if (balls[i].speedx != balls[j].speedx) {
                balls[i].speedx *= -1;
              }
              balls[j].speedx *= -1;
            } else if (balls[j].x - balls[j].radius > balls[i].x + sab_distance) { // balls[i]の右側に当たった場合
              if (balls[i].speedx != balls[j].speedx) {
                balls[j].speedx *= -1;
              }
              balls[i].speedx *= -1;
            } else if (balls[j].y + balls[j].radius <= balls[i].y - sab_distance) { // balls[i]の上側に当たった場合
              if (balls[i].speedy != balls[j].speedy) {
                balls[j].speedy *= -1;
              }
              balls[i].speedy *= -1;
            } else { // balls[i]の下側に当たった場合
              if (balls[i].speedy != balls[j].speedy) {
                balls[i].speedy *= -1;
              }
              balls[j].speedy *= -1;
            }

            // ボールがめり込んだ場合の補正
            correction = balls[i].radius + balls[j].radius - main_distance;
            balls[i].x += Math.ceil(correction) * balls[i].speedx / Math.abs(balls[i].speedx);
            balls[i].y += Math.ceil(correction) * balls[i].speedy / Math.abs(balls[i].speedy);
            balls[j].x += Math.ceil(correction) * balls[j].speedx / Math.abs(balls[j].speedx);
            balls[j].y += Math.ceil(correction) * balls[j].speedy / Math.abs(balls[j].speedy);
          }
        }
      }
    }

    // キャンバス内を動き回る描写
    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height); // キャンバス内の描画をすべてクリアする（X始点, Y始点, 横幅, 高さ）
      drawArc_white();
      drawArc_yellow();
      drawArc_green();
      drawArc_red();
      drawArc_gray();
      drawArc_purple();
      drawArc_blue();
      ball_bound();
      for (let i = 0; i < balls.length; i++) {
        move(i);
        wall_bound(i);
      }
    }

    // 5ミリ秒間隔で描き続ける
    setInterval(draw, 5);

  </script>
</body>

</html>